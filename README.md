# MJML Mailer

## About

This tool was built with the initial purpose of serving as a quick means of proof testing email templates built with the MJML framework. Eventually it grew to be more than that, and it's taking the shape of a suite for testing and compiling emails. You can send email samples, store templates, test for spam score (uses SpamAssassin) and compile MJML emails into regular HTML or Marketo compatible HTML.

## Requirements

Images should be PNG. Your template should be in a directory arranged the following way:

yourTemplate/\
├─ index.mjml\
├─ marketo.mjml\
├─ img/\
│ ├─ imageName.png\
│ ├─ imageName.png\
│ ├─ ...

It will only export templates with that folder structure and file names. Anything else will not work. Also, images src URLs on the mjml file must be local paths e.g. './img/imageName.png'. If they are different, the parser will not be able to replace local URLs with signed URLs generated by supabase (Yes, I'm using regular expressions, sue me!).

This tool requires Docker for the spam scoring functionality! Make sure to have it installed and running before running any of the spam commands.

## Requirements for Marketo MJML

 ***ALL top elements in the MJML file (`<mj-section>` or `<mj-wrapper>`) MUST have a `css-class` attribute. That is how the Marketo modules are going to be named. Try using a name descriptive of the function of the section/wrapper.***

 ***All lateral padding (that is, left and right padding) of top elements (`<mj-section>` or `<mj-wrapper>`), MUST be fixed. Variables are NOT allowed as values for top elements. Blame it on Outlook.***

Marketo variables can be used with the MJML, and they will be parsed for Marketo. The required syntax is as follows, and **MUST** be followed:

**Text variable:** &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`${text: variableName; default: Text with spaces and no quotation marks!}`\
**Number variable:** `${number: variableName; default: 10}` **(ONLY NUMBERS)**\
**Color variable:** &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`${color: variableName; default: #FFFFFF}` **(ONLY HEX COLORS)**
<!-- **HTML variable:** ${html: NAME; default: <html>something</html>} (ONLY HTML) -->

The name value *MUST* be a single word. Camel case is not mandatory. Single quotes are optional around name and default values. Double quotes are ***FORBIDDEN*** to avoid conflict with the HTML. All following examples are valid Marketo variables and will be correctly parsed by Mailer:

<code>${text: fontWeight; default: bold}</code>\
`${text: textAlignment; default: 'left'}`\
`${color: 'bgColor'; default: '#F7F7F7'}`\
<code>${number:&nbsp;&nbsp;&nbsp;'name'&nbsp;&nbsp;&nbsp;; &nbsp;&nbsp;&nbsp;default:&nbsp;&nbsp;&nbsp;'20'&nbsp;&nbsp;&nbsp;}</code>

The last example is meant to demonstrate that whitespaces before and after the name and default values or before and after the semi-colon will be trimmed. Whitespace before the name attribute (text, color, number) is not allowed:

`${   text: 'someName'; default: 'some text'}`

The above variable is invalid. Even though the rest of the variable is valid, the whitespace between '${' and 'text' renders it invalid.

It is preferable that you just follow the regular `\${text: coolName; default: someText}` with no whitespaces and quotation marks.

<br>

e.g.:\
`<mj-column`\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`background-color="${color: columnBgColor; default: #F2F2F2}"`\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`padding="0px ${number: columnHPadding; default: 10}px">`\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;***CHILDREN***\
`</mj-column>`

<br>

The default field is **NOT** optional. The default field of a text variable can be filled with any kind of text, whitespace and most special characters. It can be wrapped by single quotes. Whitespace before and after the start of the text will be trimmed.

Remember to follow the template correctly.

## Commands

### login \<id\> \<password\>

The package uses Nodemailer to send mails. To that end, it needs valid credentials to work. For now, it only works with Gmail. If your gmail account uses 2FA, you will need to generate a app password on your security settings.

### bucket \[-c/-d] \[name]

Creates or deletes a bucket or lists all buckets on supabase. Each bucket acts as a folder where each email template is stored. Bucket names should be easy to remember and relate to the template. Calling this command without arguments will list all existing buckets.

-c or --create creates a bucket.

-d or --delete deletes a bucket (and all files in it).

### export \[-w/-n/-i/-c/-m] \<name\> \[path]

Exports a template's .mjml and .png files to a bucket. Path is optional on Windows only.

-w or --watch will keep watching the folder's index.mjml for changes.

-n or --new-path will ignore and overwrite the saved path at paths.json.

-i or --images will skip uploading images.

-c or --clean will clean the bucket before uploading any file.

-m or --marketo will upload marketo.mjml to the bucket.

### prepare \[-m] \<name\>

Replaces all image URLs from local to remote paths with temporary URLs generated by supabase, and then parses MJML into HTML ready for mailing.

-m or --marketo will parse it into a Marketo compatible HTML. Module tags and variables have to be added manually. Future support for custom MJML components is planned.

### mail \[-m] \<name\> \<recipients\>

Sends the template on a bucket to all recipients. Recipient list should be surrounded by quotation marks and separated by commas e.g. `first@email.com, second@email.com, ...`. If you are sending to a single recipient, you can just input the email with no quotation marks, like `mailer mail someBucket some@email.com`

-m or --marketo will mail the Marketo HTML. **WARNING**: if there are any variables in the MJML, Mailer will send it as is. A future implementation should replace all variables with their respective defaults when sending a Marketo HTML.

### import \<name\>

Downloads the template's files from the supabase bucket. Files are saved at `root/downloads`.

### spam \[-b, -t, -l]

This command runs the functions required to set up and run SpamAssassin.

-b or --build will build SpamAssassin's Docker image.

-t or --test will fetch the last email compiled with `mailer prepare`, convert it to RFC822 and run it through SpamAssassin's tests. Will print a score to the terminal and save a log file containing more detailed information about the test. You can point Mailer to a specific HTML file by appending a path after -t

-l or --learn will run SpamAssassin through a dataset of over 10,000 emails, some spam, others ham, to train its bayes filter

## Usage

First, run `mailer`. You will be prompted for the supabase key and URL. Then run `mailer login <your@email.adress> <yourpassword>` to connect to the email from which samples will be sent.

Each template should have its own folder, implemented on supabase as buckets. Create a bucket with `mailer bucket -c <bucketname>`. Use a name that makes sense and that you will remember.

**TIP**: if you ever forget a bucket name or if it even exists and you don't want to check supabase manually, just run `mailer bucket` and Mailer will list all buckets.

Export the .mjml and .png files to the remote bucket with `mailer export <bucketname> [localpath]`. The path argument is optional. If you don't input a path, the app will open a folder select window where you can browse the filesystem for the folder where the template's files are located. The template folder MUST follow the template [here](#about) for the export to work succesfully.

Use `mailer parse [-m] <bucketname>` to parse the .MJML file into an HTML file that can then be sent over email.

To send a test email, use `mailer mail <bucketname> <"first@recipient.com, second@recipient.com, ...">`.

If you'd like to gauge the spam score of the email you've build, then first you need to build a Docker image of SpamAssassin. After installing Docker, run `mailer spam --build` to build the image. Then run `mailer spam --test` to run the test. Keep in mind that Mailer will run the last email you've ran `mailer prepare` on before, so make sure to have the email you want to test compiled.

SpamAssassin results can be improved if you train it with real examples of spam and ham. The SpamAssassin Public Corpus has been added as a dependency, and will be used to train SpamAssassin if you run the `mailer spam --learn` command. It takes a few minutes, but results can be dramatically improved.

To download the a template's files, including images, the MJML file and either regular or Marketo HTML, use `mailer import <bucketname>`. If you don't use any flag, the regular HTML will be downloaded.

## Known bugs

### After selecting a folder, Mailer says the path is invalid

Sometimes, when selecting a folder from the dialog, Mailer will accuse the path of being broken. That is because win-select-folder is not working properly. If you encounter this bug, just select the folder again and it should work.

### After running `mailer export` and trying to run `mailer prepare`, Mailer says it can't find the template

Sometimes, after running `mailer export`, the template will not be found when running `mailer prepare`. This is because something went wrong with the upload. There could be many reasons for that, out of our control. If you encounter this bug, just run `mailer export` again and it should work.